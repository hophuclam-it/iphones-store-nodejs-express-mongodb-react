<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <title>Th√™m s·∫£n ph·∫©m m·ªõi</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .gallery-image:hover {
            opacity: 0.8;
            border: 2px solid blue;
        }
    </style>

</head>

<!-- <body class="bg-light p-4"> -->

<body class=" p-4">

    <div class="container-fluid">
        <a href="/admin/product" class="back-link">‚Üê Quay l·∫°i</a>
        <h2 class="mb-4">Th√™m s·∫£n ph·∫©m m·ªõi</h2>
        <form id="productForm" enctype="multipart/form-data">
            <div class="mb-3">
                <label class="form-label">T√™n s·∫£n ph·∫©m <span class="text-danger">*</span></label>
                <input type="text" class="form-control" name="name" required>
            </div>

            <div class="mb-3">
                <label class="form-label">M√¥ t·∫£</label>
                <textarea class="form-control" name="description"></textarea>
            </div>

            <div class="mb-3">
                <label class="form-label">M√¥ t·∫£ chi ti·∫øt</label>
                <textarea class="form-control" name="richDescription"></textarea>
            </div>

            <div class="mb-3">
                <label for="image" class="form-label">·∫¢nh s·∫£n ph·∫©m (ƒê·∫°i di·ªán)</label>
                <input type="file" class="form-control" id="image" name="image" accept="image/*">
            </div>

            <div class="mb-3">
                <label for="images" class="form-label">·∫¢nh s·∫£n ph·∫©m</label>
                <input type="file" class="form-control" id="images" name="images" accept="image/*" multiple>
                <button type="button" class="btn btn-sm btn-outline-primary mt-2"
                    onclick="openImageGalleryForImages()">Ch·ªçn ·∫£nh t·ª´ th∆∞ vi·ªán</button>
                <div id="imagesPreview" class="mt-2 d-flex gap-2 flex-wrap">
                    <!-- Preview c√°c ·∫£nh ƒë√£ ch·ªçn s·∫Ω hi·ªÉn th·ªã ·ªü ƒë√¢y -->
                </div>
                <input type="hidden" id="imagesUrls" name="imagesUrls">
            </div>



            <div class="mb-3">
                <label class="form-label">Th∆∞∆°ng hi·ªáu</label>
                <input type="text" class="form-control" name="brand" value="Apple">
            </div>

            <div class="mb-3">
                <label class="form-label">Ch·ªçn danh m·ª•c <span class="text-danger">*</span></label>
                <select class="form-select" name="category" id="categorySelect" required>
                    <option value="">-- ƒêang t·∫£i danh m·ª•c... --</option>
                </select>
            </div>


            <div class="mb-3">
                <label class="form-label">S·∫£n ph·∫©m n·ªïi b·∫≠t?</label>
                <select class="form-select" name="isFeatured">
                    <option value="false">Kh√¥ng</option>
                    <option value="true">C√≥</option>

                </select>
            </div>

            <hr>
            <h4>Th√¥ng s·ªë k·ªπ thu·∫≠t</h4>
            <div class="row g-2">
                <div class="col-md-3"><input type="text" name="specs[screen]" class="form-control"
                        placeholder="M√†n h√¨nh"></div>
                <div class="col-md-3"><input type="text" name="specs[chip]" class="form-control"
                        placeholder="Chip x·ª≠ l√Ω"></div>
                <div class="col-md-3"><input type="text" name="specs[camera]" class="form-control" placeholder="Camera">
                </div>
                <div class="col-md-3"><input type="text" name="specs[battery]" class="form-control" placeholder="Pin">
                </div>
            </div>

            <hr>


            <h4>Bi·∫øn th·ªÉ s·∫£n ph·∫©m</h4>
            <!-- Bi·∫øn th·ªÉ m·∫∑c ƒë·ªãnh -->
            <div class="border rounded p-3 mb-3 position-relative" id="variant-0">
                <h5>Bi·∫øn th·ªÉ m·∫∑c ƒë·ªãnh</h5>
                <div class="row g-2">
                    <div class="col-md-4">
                        <label for="variantStorage-0" class="form-label">Dung l∆∞·ª£ng</label>
                        <input type="text" class="form-control" id="variantStorage-0" name="variantStorage-0"
                            placeholder="VD: 128GB, 256GB">
                    </div>
                    <div class="col-md-4">
                        <label for="variantColor-0" class="form-label">M√†u s·∫Øc</label>
                        <input type="text" class="form-control" id="variantColor-0" name="variantColor-0"
                            placeholder="VD: M√†u Tr·∫Øng, M√†u ƒêen">
                    </div>
                    <div class="col-md-4 mt-2">
                        <label for="variantStock-0" class="form-label">T·ªìn kho</label>
                        <input type="number" class="form-control" id="variantStock-0" name="variantStock-0"
                            placeholder="VD: 100">
                    </div>
                    <div class="col-md-4">
                        <label for="variantPrice-0" class="form-label">Gi√°</label>
                        <input type="number" class="form-control" id="variantPrice-0" name="variantPrice-0"
                            placeholder="VD: 30000000">
                    </div>
                    <div class="col-md-4 mt-2">
                        <label for="variantDiscount-0" class="form-label">Gi·∫£m gi√° (%)</label>
                        <input type="number" class="form-control" id="variantDiscount-0" name="variantDiscount-0"
                            placeholder="VD: 3%">
                    </div>

                    <div class="col-md-4 mt-2">
                        <label for="variantImagesUrl-0" class="form-label">H√¨nh ·∫£nh</label> <br>
                        <button type="button" class="btn btn-sm btn-outline-primary" onclick="openImageGallery(0)">Ch·ªçn
                            ·∫£nh t·ª´ th∆∞ vi·ªán</button>
                    </div>
                    <div class="col-md mt-2">
                        <div id="galleryPreview-0" class="mt-2 d-flex gap-2 flex-wrap"></div>
                    </div>
                    <input type="hidden" name="variantImagesUrl-0">
                </div>
            </div>
            <div class="border p-3 mb-3 bg-white">
                <div class="row g-2">
                    <div class="col-md-3">
                        <label class="form-label">Dung l∆∞·ª£ng (ph√¢n t√°ch b·ªüi d·∫•u ph·∫©y)</label>
                        <input type="text" class="form-control" id="autoStorages" placeholder="VD: 128GB, 256GB, 1TB">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">M√†u s·∫Øc (ph√¢n t√°ch b·ªüi d·∫•u ph·∫©y)</label>
                        <input type="text" class="form-control" id="autoColors" placeholder="VD: M√†u Tr·∫Øng, ƒêen, V√†ng">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Gi√° chu·∫©n</label>
                        <input type="number" class="form-control" id="autoPrice" placeholder="VD: 30000000">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Gi·∫£m gi√°</label>
                        <input type="number" class="form-control" id="autoDiscount" placeholder="VD: 10">
                    </div>

                </div>
                <button type="button" class="btn btn-warning mt-3" onclick="generateVariants()">üîÑ T·∫°o bi·∫øn th·ªÉ t·ª±
                    ƒë·ªông</button>
            </div>


            <!-- Container cho c√°c bi·∫øn th·ªÉ th√™m v√†o -->
            <div id="variants"></div>


            <button type="button" class="btn btn-secondary my-3" onclick="addVariant()">+ Th√™m bi·∫øn th·ªÉ</button>

            <button type="submit" class="btn btn-primary">Th√™m s·∫£n ph·∫©m</button>
        </form>

        <div id="result" class="mt-4"></div>
    </div>

    <script>
        // Load categories khi trang load
        window.addEventListener('DOMContentLoaded', async () => {
            try {
                const res = await fetch('http://localhost:5000/api/categories');
                const categories = await res.json();

                const select = document.getElementById('categorySelect');
                select.innerHTML = `<option value="">-- Ch·ªçn danh m·ª•c --</option>`;

                categories.forEach(cat => {
                    const option = document.createElement('option');
                    option.value = cat._id;
                    option.textContent = cat.name;
                    select.appendChild(option);
                });
            } catch (err) {
                console.error('L·ªói khi l·∫•y danh m·ª•c:', err);
                const select = document.getElementById('categorySelect');
                select.innerHTML = `<option value="">Kh√¥ng t·∫£i ƒë∆∞·ª£c danh m·ª•c</option>`;
            }
        });

        let variantIndex = 1; // B·∫Øt ƒë·∫ßu t·ª´ 1 ƒë·ªÉ tr√°nh tr√πng v·ªõi bi·∫øn th·ªÉ m·∫∑c ƒë·ªãnh

        function addVariant() {
            if (variantIndex >= 10) { // Gi·ªõi h·∫°n s·ªë l∆∞·ª£ng bi·∫øn th·ªÉ
                alert("B·∫°n kh√¥ng th·ªÉ th√™m qu√° 10 bi·∫øn th·ªÉ.");
                return;
            }

            const variantId = variantIndex++;

            const variantHtml = `
            <div class="border rounded p-3 mb-3 position-relative" id="variant-${variantId}">
            <button type="button" class="btn-close position-absolute top-0 end-0 m-2" aria-label="X√≥a" onclick="removeVariant(${variantId})"></button>
            <h5>Bi·∫øn th·ªÉ #${variantId + 1}</h5>
            <div class="row g-2">
                <div class="col-md-4"><input type="text" class="form-control" name="variantColor-${variantId}" placeholder="M√†u s·∫Øc" required></div>
                <div class="col-md-4"><input type="text" class="form-control" name="variantStorage-${variantId}" placeholder="Dung l∆∞·ª£ng" required></div>
                <div class="col-md-4"><input type="number" class="form-control" name="variantPrice-${variantId}" placeholder="Gi√°" required></div>
                <div class="col-md-4 mt-2"><input type="number" class="form-control" name="variantDiscount-${variantId}" placeholder="Gi·∫£m gi√° (%)" value="0"></div>
                <div class="col-md-4 mt-2"><input type="number" class="form-control" name="variantStock-${variantId}" placeholder="T·ªìn kho" required></div>
                <div class="col-md-4 mt-2">
                        <button type="button" class="btn btn-sm btn-outline-primary" onclick="openImageGallery(${variantId})">Ch·ªçn ·∫£nh t·ª´ th∆∞ vi·ªán</button>
                    </div>
                    <div class="col-md mt-2">
                        <div id="galleryPreview-${variantId}" class="mt-2 d-flex gap-2 flex-wrap"></div>
                    </div>
                    <input type="hidden" name="variantImagesUrl-${variantId}">
                </div>
            </div>
            </div>`;

            document.getElementById("variants").insertAdjacentHTML('beforeend', variantHtml);
        }

        function removeVariant(id) {
            const variantsContainer = document.getElementById('variants');
            const allVariants = variantsContainer.querySelectorAll('[id^="variant-"]');

            const el = document.getElementById(`variant-${id}`);
            if (el) el.remove();
            variantIndex--; // Gi·∫£m ch·ªâ s·ªë bi·∫øn th·ªÉ khi x√≥a
            delete selectedGalleryImages[id];
        }

        function generateVariants() {
            const colors = document.getElementById('autoColors').value.split(',').map(c => c.trim()).filter(Boolean);
            const storages = document.getElementById('autoStorages').value.split(',').map(s => s.trim()).filter(Boolean);
            const price = parseFloat(document.getElementById('autoPrice').value) || 0;
            const discount = parseFloat(document.getElementById('autoDiscount').value) || 0;


            if (colors.length === 0 || storages.length === 0) {
                alert("Vui l√≤ng nh·∫≠p √≠t nh·∫•t 1 m√†u v√† 1 dung l∆∞·ª£ng.");
                return;
            }


            storages.forEach(storage => {
                colors.forEach(color => {
                    const variantId = variantIndex++;

                    if (variantIndex > 100) {
                        alert("B·∫°n kh√¥ng th·ªÉ th√™m qu√° 100 bi·∫øn th·ªÉ.");
                        return;
                    }

                    const variantHtml = `
                    <div class="border rounded p-3 mb-3 position-relative" id="variant-${variantId}">
                        <button type="button" class="btn-close position-absolute top-0 end-0 m-2" aria-label="X√≥a" onclick="removeVariant(${variantId})"></button>
                        <h5>Bi·∫øn th·ªÉ:  ${storage} - ${color}</h5>
                        <div class="row g-2">
                            <div class="col-md-4"><input type="text" class="form-control" name="variantStorage-${variantId}" value="${storage}" required></div>
                            <div class="col-md-4"><input type="text" class="form-control" name="variantColor-${variantId}" value="${color}" required></div>
                            <div class="col-md-4 mt-2"><input type="number" class="form-control" name="variantStock-${variantId}" placeholder="T·ªìn kho" required></div>
                            <div class="col-md-4"><input type="number" class="form-control" name="variantPrice-${variantId}" value="${price}" required></div>
                            <div class="col-md-4 mt-2"><input type="number" class="form-control" name="variantDiscount-${variantId}" placeholder="Gi·∫£m gi√° (%)" value="${discount}"></div>
                            <div class="col-md-4 mt-2">
                        <button type="button" class="btn btn-sm btn-outline-primary" onclick="openImageGallery(${variantId})">Ch·ªçn ·∫£nh t·ª´ th∆∞ vi·ªán</button>
                            </div>
                            <div class="col-md mt-2">
                                <div id="galleryPreview-${variantId}" class="mt-2 d-flex gap-2 flex-wrap"></div>
                            </div>
                            <input type="hidden" name="variantImagesUrl-${variantId}">
                        </div>
                    </div>`;

                    document.getElementById("variants").insertAdjacentHTML('beforeend', variantHtml);
                });
            });
        }



        // X·ª≠ l√Ω submit form
        document.getElementById('productForm').addEventListener('submit', async function (e) {
            e.preventDefault();

            const form = e.target;
            const formData = new FormData();

            // Basic fields
            formData.append('name', form.name.value);
            formData.append('description', form.description.value);
            formData.append('richDescription', form.richDescription.value);
            formData.append('brand', form.brand.value);
            formData.append('category', form.category.value);
            formData.append('isFeatured', form.isFeatured.value === 'true');

            // Specs as object
            const specs = {
                screen: form["specs[screen]"].value,
                chip: form["specs[chip]"].value,
                camera: form["specs[camera]"].value,
                battery: form["specs[battery]"].value
            };
            formData.append('specs', JSON.stringify(specs));


            // Images (nhi·ªÅu ·∫£nh)
            const imagesUrls = form.imagesUrls.value
                .split(',')
                .map(url => url.trim())
                .filter(Boolean)
                .map(url => url.startsWith('http') ? url : `http://localhost:5000${url}`); // Th√™m ti·ªÅn t·ªë n·∫øu c·∫ßn

            formData.append('images', JSON.stringify(imagesUrls)); // L∆∞u danh s√°ch ·∫£nh d∆∞·ªõi d·∫°ng JSON

            // Main product image
            if (form.image && form.image.files && form.image.files.length > 0) {
                // N·∫øu ng∆∞·ªùi d√πng upload ·∫£nh ƒë·∫°i di·ªán, s·ª≠ d·ª•ng ·∫£nh ƒë√≥
                formData.append('image', form.image.files[0]);
            } else if (imagesUrls.length > 0) {
                // N·∫øu kh√¥ng, l·∫•y ·∫£nh ƒë·∫ßu ti√™n t·ª´ danh s√°ch images l√†m ·∫£nh ƒë·∫°i di·ªán
                formData.append('image', imagesUrls[0]);
            }

            // Build variants
            const variants = [];
            const variantImages = []; // store all variant images to append to formData

            const variantElements = document.querySelectorAll('[id^="variant-"]');

            variantElements.forEach(variantEl => {
                const id = variantEl.id.split('-')[1]; // L·∫•y ch·ªâ s·ªë, v√≠ d·ª• '2' t·ª´ id="variant-2"

                const color = form[`variantColor-${id}`]?.value;
                const storage = form[`variantStorage-${id}`]?.value;
                const price = parseFloat(form[`variantPrice-${id}`]?.value || 0);
                const discount = parseFloat(form[`variantDiscount-${id}`]?.value || 0);
                const stock = parseInt(form[`variantStock-${id}`]?.value || 0);

                if (!color || !storage) return;

                const variant = { color, storage, price, discount, stock, images: [] };

                // X·ª≠ l√Ω ·∫£nh bi·∫øn th·ªÉ
                const fileInput = form[`variantImagesFile-${id}`];
                const url = form[`variantImagesUrl-${id}`]?.value;

                if (fileInput?.files?.length > 0) {
                    Array.from(fileInput.files).forEach(file => {
                        const fileKey = `variant-${id}-${file.name}`;
                        formData.append('variantImages', file, fileKey);
                        variant.images.push(fileKey);
                    });
                } else if (url) {
                    variant.images.push(...url.split(',').map(s => s.trim()).filter(Boolean));
                }

                variants.push(variant);
            });

            formData.append('variants', JSON.stringify(variants));
            console.log(variants);


            // Submit form
            try {
                const response = await fetch('http://localhost:5000/api/products', {
                    method: 'POST',
                    body: formData
                });



                if (response.ok) {
                    document.getElementById("result").innerHTML = `<div class="alert alert-success">‚úî Th√™m s·∫£n ph·∫©m th√†nh c√¥ng</div>`;
                    form.reset();
                    // console.log(result);
                    // console.log(formData);

                } else {
                    document.getElementById("result").innerHTML = `<div class="alert alert-danger">‚ùå C√≥ l·ªói x·∫£y ra</div>`;
                }
            } catch (err) {
                console.error(err);
                document.getElementById("result").innerHTML = `<div class="alert alert-danger">‚ùå L·ªói khi g·ª≠i d·ªØ li·ªáu</div>`;
            }
        });




        let currentGalleryTarget = null; // Bi·∫øn l∆∞u tr·ªØ bi·∫øn th·ªÉ hi·ªán t·∫°i
        let selectedGalleryImages = {}; // L∆∞u tr·ªØ ·∫£nh ƒë√£ ch·ªçn cho t·ª´ng bi·∫øn th·ªÉ

        // M·ªü modal v√† t·∫£i ·∫£nh t·ª´ th∆∞ vi·ªán
        async function openImageGallery(variantIndex) {
            currentGalleryTarget = variantIndex;

            try {
                const res = await fetch("http://localhost:5000/api/uploads");
                const images = await res.json();
                const container = document.getElementById("galleryImagesContainer");
                container.innerHTML = '';

                const selected = selectedGalleryImages[variantIndex] || [];
                const groupedImages = groupImagesByTime(images);

                for (const [groupName, groupImages] of Object.entries(groupedImages)) {
                    if (groupImages.length === 0) continue;

                    const groupTitle = document.createElement("h6");
                    groupTitle.innerText = groupName;
                    container.appendChild(groupTitle);
             

                     // Ng·∫Øt d√≤ng tr∆∞·ªõc nh√≥m
                     const preLineBreak = document.createElement("div");
                    preLineBreak.className = "w-100";
                    container.appendChild(preLineBreak);


                    const groupRow = document.createElement("div");
                    groupRow.className = "d-flex flex-wrap mb-2";

                    groupImages.forEach(img => {
                        const isSelected = selected.includes(img.url);

                        const imgEl = document.createElement("img");
                        imgEl.src = img.url;
                        imgEl.className = "img-thumbnail m-1";
                        imgEl.style.width = "100px";
                        imgEl.style.cursor = "pointer";
                        imgEl.style.opacity = isSelected ? "0.5" : "1";
                        imgEl.style.border = isSelected ? "2px solid green" : "none";
                        imgEl.title = img.url; // Hi·ªÉn th·ªã URL khi hover

                        imgEl.onclick = () => {
                            toggleImageSelection(img.url);
                        };

                        groupRow.appendChild(imgEl);
                    });

                    container.appendChild(groupRow);

                    
                    // Ng·∫Øt d√≤ng sau nh√≥m
                    const postLineBreak = document.createElement("div");
                    postLineBreak.className = "w-100";
                    container.appendChild(postLineBreak);
                }

                // Hi·ªÉn th·ªã modal n·∫øu ch∆∞a m·ªü
                let modalInstance = bootstrap.Modal.getInstance(document.getElementById("imageGalleryModal"));
                if (!modalInstance) {
                    modalInstance = new bootstrap.Modal(document.getElementById("imageGalleryModal"));
                }
                modalInstance.show();

            } catch (err) {
                console.error("L·ªói khi t·∫£i danh s√°ch ·∫£nh:", err);
            }
        }

        // X·ª≠ l√Ω ch·ªçn v√† b·ªè ch·ªçn ·∫£nh
        function toggleImageSelection(imgUrl) {
            const selectedImages = selectedGalleryImages[currentGalleryTarget] || [];
            const index = selectedImages.indexOf(imgUrl);
            if (index !== -1) {
                selectedImages.splice(index, 1); // X√≥a ·∫£nh kh·ªèi danh s√°ch
            } else {
                selectedImages.push(imgUrl); // Th√™m ·∫£nh v√†o danh s√°ch
            }
            selectedGalleryImages[currentGalleryTarget] = selectedImages;
            showGalleryPreview(currentGalleryTarget); // C·∫≠p nh·∫≠t preview ·∫£nh
            openImageGallery(currentGalleryTarget); // M·ªü l·∫°i modal ƒë·ªÉ c·∫≠p nh·∫≠t tr·∫°ng th√°i
        }



        function showGalleryPreview(variantIndex) {
            const preview = document.getElementById(`galleryPreview-${variantIndex}`);
            if (!preview) return;

            preview.innerHTML = ''; // L√†m s·∫°ch preview

            (selectedGalleryImages[variantIndex] || []).forEach((url, index) => {
                const wrapper = document.createElement("div");
                wrapper.className = "position-relative d-inline-block";

                const img = document.createElement("img");
                img.src = url;
                img.className = "img-thumbnail";
                img.style.width = "80px";
                img.style.height = "80px";
                img.style.objectFit = "cover";
                img.style.marginRight = "2px";

                const closeBtn = document.createElement("button");
                closeBtn.innerHTML = "&times;";
                closeBtn.className = "btn btn-sm btn-danger position-absolute top-0 end-0";
                closeBtn.style.transform = "translate(30%, -30%)";
                closeBtn.onclick = () => {
                    selectedGalleryImages[variantIndex].splice(index, 1);
                    showGalleryPreview(variantIndex); // C·∫≠p nh·∫≠t l·∫°i preview
                };

                wrapper.appendChild(img);
                wrapper.appendChild(closeBtn);
                preview.appendChild(wrapper);
            });

            // C·∫≠p nh·∫≠t input ·∫©n n·∫øu c√≥
            const input = document.querySelector(`[name="variantImagesUrl-${variantIndex}"]`);
            if (input) {
                input.value = selectedGalleryImages[variantIndex].join(", ");
            }
        }

        function groupImagesByTime(images) {
            const now = new Date();
            const groups = {
                "H√¥m nay": [],
                "H√¥m qua": [],
                "7 ng√†y qua": [],
                "30 ng√†y qua": [],
                "C≈© h∆°n": []
            };

            images.forEach(img => {
                const created = new Date(img.createdAt);
                const diffMs = now - created;
                const diffDays = diffMs / (1000 * 60 * 60 * 24);

                if (diffDays < 1) {
                    groups["H√¥m nay"].push(img);
                } else if (diffDays < 2) {
                    groups["H√¥m qua"].push(img);
                } else if (diffDays < 7) {
                    groups["7 ng√†y qua"].push(img);
                } else if (diffDays < 30) {
                    groups["30 ng√†y qua"].push(img);
                } else {
                    groups["C≈© h∆°n"].push(img);
                }
            });

            return groups;
        }




        document.addEventListener('DOMContentLoaded', function () {
            const uploadForm = document.getElementById("uploadForm");

            if (uploadForm) {
                uploadForm.addEventListener("submit", async function (e) {
                    e.preventDefault();

                    const fileInput = document.getElementById("uploadImage");
                    const status = document.getElementById("uploadStatus");
                    status.textContent = "ƒêang t·∫£i l√™n...";

                    if (fileInput.files.length === 0) return;

                    const formData = new FormData();

                    Array.from(fileInput.files).forEach(file => {
                        formData.append("files", file);
                    });

                    try {
                        const response = await fetch("http://localhost:5000/api/uploads/multiple", {
                            method: "POST",
                            body: formData,
                        });

                        const data = await response.json();
                        if (response.ok) {
                            status.textContent = "T·∫£i ·∫£nh th√†nh c√¥ng!";
                            fileInput.value = ""; // Reset input file
                            // Load l·∫°i ·∫£nh t·ª´ th∆∞ vi·ªán sau khi t·∫£i ·∫£nh m·ªõi l√™n
                            await openImageGallery(currentGalleryTarget);
                        } else {
                            status.textContent = "Kh√¥ng qu√° 10 ·∫£nh trong 1 l·∫ßn t·∫£i l√™n. L·ªói: " + (data.message || "Kh√¥ng r√µ nguy√™n nh√¢n");
                        }
                    } catch (err) {
                        status.textContent = "L·ªói k·∫øt n·ªëi m√°y ch·ªß.";
                        console.error(err);
                    }
                });
            }
        });


        // Khi m·ªü modal ch·ªçn ·∫£nh cho s·∫£n ph·∫©m (images)
        async function openImageGalleryForImages() {
            currentGalleryTarget = 'images';
            try {
                const res = await fetch("http://localhost:5000/api/uploads");
                const images = await res.json();
                const container = document.getElementById("galleryImagesContainer");
                container.innerHTML = '';

                const selected = selectedGalleryImages['images'] || [];
                const groupedImages = groupImagesByTime(images);

                for (const [groupName, groupImages] of Object.entries(groupedImages)) {
                    if (groupImages.length === 0) continue;

                    const groupTitle = document.createElement("h6");
                    groupTitle.innerText = groupName;
                    container.appendChild(groupTitle);


                    // Ng·∫Øt d√≤ng tr∆∞·ªõc nh√≥m
                    const preLineBreak = document.createElement("div");
                    preLineBreak.className = "w-100";
                    container.appendChild(preLineBreak);



                    const groupRow = document.createElement("div");
                    groupRow.className = "d-flex flex-wrap mb-2";

                    groupImages.forEach(img => {
                        const isSelected = selected.includes(img.url);

                        const imgEl = document.createElement("img");
                        imgEl.src = img.url;
                        imgEl.className = "img-thumbnail m-1 gallery-image"; // Th√™m class gallery-image ƒë·ªÉ d·ªÖ x·ª≠ l√Ω
                        imgEl.style.width = "100px";
                        imgEl.style.cursor = "pointer";
                        imgEl.style.opacity = isSelected ? "0.5" : "1";
                        imgEl.style.border = isSelected ? "2px solid green" : "none";
                        imgEl.title = img.url;

                        imgEl.onclick = () => {
                            toggleImageSelectionForImages(img.url, imgEl);
                        };

                        groupRow.appendChild(imgEl);
                    });


                    container.appendChild(groupRow);


                    // Ng·∫Øt d√≤ng sau nh√≥m
                    const postLineBreak = document.createElement("div");
                    postLineBreak.className = "w-100";
                    container.appendChild(postLineBreak);
                }

                let modalInstance = bootstrap.Modal.getInstance(document.getElementById("imageGalleryModal"));
                if (!modalInstance) {
                    modalInstance = new bootstrap.Modal(document.getElementById("imageGalleryModal"));
                }
                modalInstance.show();

            } catch (err) {
                console.error("L·ªói khi t·∫£i danh s√°ch ·∫£nh:", err);
            }
        }

        // H√†m ch·ªçn/b·ªè ch·ªçn ·∫£nh cho s·∫£n ph·∫©m
        function toggleImageSelectionForImages(imgUrl, imgEl) {
            const selectedImages = selectedGalleryImages['images'] || [];
            const index = selectedImages.indexOf(imgUrl);

            if (index !== -1) {
                selectedImages.splice(index, 1); // B·ªè ch·ªçn
            } else {
                selectedImages.push(imgUrl); // Ch·ªçn th√™m
            }

            selectedGalleryImages['images'] = selectedImages;

            // C·∫≠p nh·∫≠t style ngay cho ·∫£nh v·ª´a click
            if (selectedImages.includes(imgUrl)) {
                imgEl.style.opacity = "0.5";
                imgEl.style.border = "2px solid green";
            } else {
                imgEl.style.opacity = "1";
                imgEl.style.border = "none";
            }

            showImagesPreview(); // C·∫≠p nh·∫≠t l·∫°i preview
        }

        // H√†m hi·ªÉn th·ªã ·∫£nh preview cho s·∫£n ph·∫©m
        function showImagesPreview() {
            const preview = document.getElementById("imagesPreview");
            if (!preview) return;

            preview.innerHTML = '';

            (selectedGalleryImages['images'] || []).forEach((url, index) => {
                const wrapper = document.createElement("div");
                wrapper.className = "position-relative d-inline-block";

                const img = document.createElement("img");
                img.src = url;
                img.className = "img-thumbnail";
                img.style.width = "80px";
                img.style.height = "80px";
                img.style.objectFit = "cover";
                img.style.marginRight = "2px";

                const closeBtn = document.createElement("button");
                closeBtn.innerHTML = "&times;";
                closeBtn.className = "btn btn-sm btn-danger position-absolute top-0 end-0";
                closeBtn.style.transform = "translate(30%, -30%)";
                closeBtn.onclick = () => {
                    selectedGalleryImages['images'].splice(index, 1);
                    showImagesPreview(); // C·∫≠p nh·∫≠t preview
                    updateGalleryImageStyles(); // C·∫≠p nh·∫≠t style ·∫£nh trong modal n·∫øu modal ƒëang m·ªü
                };

                wrapper.appendChild(img);
                wrapper.appendChild(closeBtn);
                preview.appendChild(wrapper);
            });

            // C·∫≠p nh·∫≠t input hidden
            const input = document.getElementById("imagesUrls");
            if (input) {
                input.value = selectedGalleryImages['images']
                    .map(url => url.startsWith('http') ? url : `http://localhost:5000${url}`)
                    .join(", ");
            }
        }

        // H√†m c·∫≠p nh·∫≠t l·∫°i style t·∫•t c·∫£ ·∫£nh trong modal
        function updateGalleryImageStyles() {
            const selectedImages = selectedGalleryImages['images'] || [];
            const galleryImages = document.querySelectorAll("#galleryImagesContainer img.gallery-image");

            galleryImages.forEach(imgEl => {
                if (selectedImages.includes(imgEl.src)) {
                    imgEl.style.opacity = "0.5";
                    imgEl.style.border = "2px solid green";
                } else {
                    imgEl.style.opacity = "1";
                    imgEl.style.border = "none";
                }
            });
        }




    </script>


    <!-- Modal ch·ªçn ·∫£nh t·ª´ th∆∞ vi·ªán -->
    <div class="modal fade" id="imageGalleryModal" tabindex="-1" aria-labelledby="imageGalleryModalLabel"
        aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Ch·ªçn ·∫£nh t·ª´ th∆∞ vi·ªán</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body overflow-auto" style="max-height: 75vh; padding-right: 0px;">
                    <div id="galleryImagesContainer" class="mb-4 d-flex flex-wrap gap-2">
                        <!-- ·∫¢nh s·∫Ω ƒë∆∞·ª£c load t·ª´ server -->
                    </div>

                </div>
                <div class="modal-footer justify-content-between">
                    <form id="uploadForm" enctype="multipart/form-data">
                        <div class="input-group">
                            <input type="file" class="form-control" name="image" id="uploadImage" accept="image/*"
                                multiple required>
                            <button class="btn btn-primary" type="submit">T·∫£i l√™n</button>
                        </div>
                    </form>
                    <div id="uploadStatus" class="text-muted small"></div>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ƒê√≥ng</button>

                </div>
            </div>
        </div>
    </div>


</body>
<!-- Bootstrap JS (v5) -->

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

</html>